<!-- MCP Server Configuration Modal -->
<div id="mcp-config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>MCP Server Configuration</h2>
            <button class="close-btn" onclick="closeMCPConfig()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="server-categories">
                <!-- System Tools -->
                <div class="category-section">
                    <h3>System Control</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-powershell" onchange="toggleServer('powershell')">
                                <span class="server-name">PowerShell</span>
                            </label>
                            <p class="server-desc">Execute PowerShell commands on your system</p>
                            <div class="server-status" id="status-powershell">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-filesystem" checked onchange="toggleServer('filesystem')">
                                <span class="server-name">Filesystem</span>
                            </label>
                            <p class="server-desc">Read and write files and directories</p>
                            <div class="server-status enabled" id="status-filesystem">Enabled</div>
                        </div>
                    </div>
                </div>

                <!-- Web Tools -->
                <div class="category-section">
                    <h3>Web & Browser</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-puppeteer" onchange="toggleServer('puppeteer')">
                                <span class="server-name">Puppeteer (Browser Control)</span>
                            </label>
                            <p class="server-desc">Control web browser, navigate pages, scrape content</p>
                            <div class="server-status" id="status-puppeteer">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-brave_search" onchange="toggleServer('brave_search')">
                                <span class="server-name">Brave Search</span>
                            </label>
                            <p class="server-desc">Search the web using Brave Search API</p>
                            <div class="server-status" id="status-brave_search">Requires API Key</div>
                        </div>
                        <div class="server-config">
                            <input type="text" placeholder="Brave API Key" id="config-brave_search-key">
                        </div>
                    </div>
                </div>

                <!-- Development Tools -->
                <div class="category-section">
                    <h3>Development</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-github" onchange="toggleServer('github')">
                                <span class="server-name">GitHub</span>
                            </label>
                            <p class="server-desc">Manage repositories, issues, pull requests</p>
                            <div class="server-status" id="status-github">Requires Token</div>
                        </div>
                        <div class="server-config">
                            <input type="password" placeholder="GitHub Personal Access Token" id="config-github-token">
                        </div>
                    </div>
                </div>

                <!-- Utility Tools -->
                <div class="category-section">
                    <h3>Utilities</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-sequential_thinking" onchange="toggleServer('sequential_thinking')">
                                <span class="server-name">Sequential Thinking</span>
                            </label>
                            <p class="server-desc">Step-by-step reasoning and problem solving</p>
                            <div class="server-status" id="status-sequential_thinking">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-memory" onchange="toggleServer('memory')">
                                <span class="server-name">Memory/Notes</span>
                            </label>
                            <p class="server-desc">Persistent note-taking and memory storage</p>
                            <div class="server-status" id="status-memory">Disabled</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeMCPConfig()">Cancel</button>
            <button class="btn-primary" onclick="saveMCPConfig()">Apply Changes</button>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
    background-color: #2d2d30;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #3e3e42;
    border-radius: 8px;
    width: 80%;
    max-width: 800px;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #3e3e42;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
    color: #ffffff;
}

.close-btn {
    background: none;
    border: none;
    color: #858585;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    line-height: 28px;
}

.close-btn:hover {
    color: #ffffff;
}

.modal-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}

.category-section {
    margin-bottom: 30px;
}

.category-section h3 {
    font-size: 14px;
    color: #4ec9b0;
    margin-bottom: 15px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.server-item {
    background: #252526;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 4px;
    border-left: 3px solid transparent;
}

.server-item:hover {
    background: #2a2a2b;
}

.server-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-bottom: 8px;
}

.server-checkbox input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.server-name {
    font-size: 14px;
    font-weight: 600;
    color: #cccccc;
}

.server-desc {
    font-size: 12px;
    color: #858585;
    margin: 5px 0 8px 28px;
}

.server-status {
    font-size: 11px;
    color: #858585;
    margin-left: 28px;
    padding: 3px 8px;
    background: #3c3c3c;
    border-radius: 3px;
    display: inline-block;
}

.server-status.enabled {
    color: #4ec9b0;
    background: rgba(78, 201, 176, 0.15);
}

.server-status.error {
    color: #f48771;
    background: rgba(244, 135, 113, 0.15);
}

.server-config {
    margin: 10px 0 0 28px;
}

.server-config input {
    width: 100%;
    max-width: 400px;
    padding: 8px 12px;
    background: #3c3c3c;
    border: 1px solid #3e3e42;
    border-radius: 4px;
    color: #d4d4d4;
    font-size: 12px;
}

.server-config input:focus {
    outline: none;
    border-color: #0e639c;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #3e3e42;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn-primary, .btn-secondary {
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
}

.btn-primary {
    background: #0e639c;
    color: white;
}

.btn-primary:hover {
    background: #1177bb;
}

.btn-secondary {
    background: #3c3c3c;
    color: #cccccc;
}

.btn-secondary:hover {
    background: #4e4e52;
}
</style>

<script>
function openMCPConfig() {
    document.getElementById('mcp-config-modal').style.display = 'block';
    loadMCPServerStates();
}

function closeMCPConfig() {
    document.getElementById('mcp-config-modal').style.display = 'none';
}

async function loadMCPServerStates() {
    try {
        const response = await fetch('/api/mcp/config');
        const config = await response.json();

        // Update checkboxes based on current config
        config.servers.forEach(server => {
            const checkbox = document.getElementById(`server-${server.name}`);
            if (checkbox) {
                checkbox.checked = server.enabled;
            }
        });
    } catch (error) {
        console.error('Failed to load MCP config:', error);
    }
}

async function toggleServer(serverName) {
    const checkbox = document.getElementById(`server-${serverName}`);
    const statusEl = document.getElementById(`status-${serverName}`);

    if (checkbox.checked) {
        statusEl.textContent = 'Enabling...';
        statusEl.className = 'server-status';
    } else {
        statusEl.textContent = 'Disabled';
        statusEl.className = 'server-status';
    }
}

async function saveMCPConfig() {
    const servers = [
        'filesystem', 'powershell', 'puppeteer', 'github',
        'brave_search', 'sequential_thinking', 'memory'
    ];

    const config = {};
    servers.forEach(name => {
        const checkbox = document.getElementById(`server-${name}`);
        if (checkbox) {
            config[name] = {
                enabled: checkbox.checked
            };

            // Get API keys/tokens if applicable
            const keyInput = document.getElementById(`config-${name}-key`);
            const tokenInput = document.getElementById(`config-${name}-token`);

            if (keyInput && keyInput.value) {
                config[name].api_key = keyInput.value;
            }
            if (tokenInput && tokenInput.value) {
                config[name].token = tokenInput.value;
            }
        }
    });

    try {
        const response = await fetch('/api/mcp/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });

        if (response.ok) {
            alert('MCP configuration saved! Servers will connect shortly.');
            closeMCPConfig();

            // Refresh server list
            setTimeout(() => {
                fetchMCPServers();
            }, 2000);
        } else {
            alert('Failed to save configuration');
        }
    } catch (error) {
        console.error('Failed to save MCP config:', error);
        alert('Error saving configuration');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('mcp-config-modal');
    if (event.target == modal) {
        closeMCPConfig();
    }
}
</script>
