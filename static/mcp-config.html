<!-- MCP Server Configuration Modal -->
<div id="mcp-config-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>MCP Server Configuration</h2>
            <button class="close-btn" onclick="closeMCPConfig()">&times;</button>
        </div>

        <div class="modal-body">
            <div class="server-categories">
                <!-- System Tools -->
                <div class="category-section">
                    <h3>System Control</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-powershell" onchange="toggleServer('powershell')">
                                <span class="server-name">PowerShell</span>
                            </label>
                            <p class="server-desc">Execute PowerShell commands on your system</p>
                            <div class="server-status" id="status-powershell">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-filesystem" checked onchange="toggleServer('filesystem')">
                                <span class="server-name">Filesystem</span>
                            </label>
                            <p class="server-desc">Read and write files and directories</p>
                            <div class="server-status enabled" id="status-filesystem">Enabled</div>
                        </div>
                    </div>
                </div>

                <!-- Web Tools -->
                <div class="category-section">
                    <h3>Web & Browser</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-puppeteer" onchange="toggleServer('puppeteer')">
                                <span class="server-name">Puppeteer (Browser Control)</span>
                            </label>
                            <p class="server-desc">Control web browser, navigate pages, scrape content</p>
                            <div class="server-status" id="status-puppeteer">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-brave_search" onchange="toggleServer('brave_search')">
                                <span class="server-name">Brave Search</span>
                            </label>
                            <p class="server-desc">Search the web using Brave Search API</p>
                            <div class="server-status" id="status-brave_search">Requires API Key</div>
                        </div>
                        <div class="server-config">
                            <input type="text" placeholder="Brave API Key" id="config-brave_search-key">
                        </div>
                    </div>
                </div>

                <!-- Development Tools -->
                <div class="category-section">
                    <h3>Development</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-github" onchange="toggleServer('github')">
                                <span class="server-name">GitHub</span>
                            </label>
                            <p class="server-desc">Manage repositories, issues, pull requests</p>
                            <div class="server-status" id="status-github">Requires Token</div>
                        </div>
                        <div class="server-config">
                            <input type="password" placeholder="GitHub Personal Access Token" id="config-github-token">
                        </div>
                    </div>
                </div>

                <!-- Utility Tools -->
                <div class="category-section">
                    <h3>Utilities</h3>
                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-sequential_thinking" onchange="toggleServer('sequential_thinking')">
                                <span class="server-name">Sequential Thinking</span>
                            </label>
                            <p class="server-desc">Step-by-step reasoning and problem solving</p>
                            <div class="server-status" id="status-sequential_thinking">Disabled</div>
                        </div>
                    </div>

                    <div class="server-item">
                        <div class="server-info">
                            <label class="server-checkbox">
                                <input type="checkbox" id="server-memory" onchange="toggleServer('memory')">
                                <span class="server-name">Memory/Notes</span>
                            </label>
                            <p class="server-desc">Persistent note-taking and memory storage</p>
                            <div class="server-status" id="status-memory">Disabled</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeMCPConfig()">Cancel</button>
            <button class="btn-primary" onclick="saveMCPConfig()">Apply Changes</button>
        </div>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    inset: 0;
    background-color: rgba(15, 18, 24, 0.4);
    backdrop-filter: blur(6px);
}

.modal-content {
    background-color: var(--panel-strong);
    margin: 4% auto;
    padding: 0;
    border: 1px solid var(--border);
    border-radius: 20px;
    width: min(90%, 880px);
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow);
    font-family: var(--font-sans);
    color: var(--ink-1);
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, rgba(18, 106, 111, 0.1), rgba(255, 255, 255, 0.9));
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--ink-1);
}

.close-btn {
    background: rgba(27, 31, 42, 0.05);
    border: 1px solid var(--border);
    color: var(--ink-2);
    font-size: 22px;
    cursor: pointer;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    line-height: 26px;
    transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
}

.close-btn:hover {
    color: var(--ink-1);
    background: rgba(18, 106, 111, 0.12);
    transform: translateY(-1px);
}

.modal-body {
    padding: 20px 24px;
    overflow-y: auto;
    flex: 1;
    background: var(--panel);
}

.category-section {
    margin-bottom: 28px;
}

.category-section h3 {
    font-size: 12px;
    color: var(--accent-1);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.18em;
}

.server-item {
    background: rgba(255, 255, 255, 0.85);
    padding: 14px 16px;
    margin-bottom: 10px;
    border-radius: 14px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-tight);
}

.server-item:hover {
    border-color: var(--border-strong);
}

.server-checkbox {
    display: flex;
    align-items: center;
    cursor: pointer;
    margin-bottom: 6px;
}

.server-checkbox input[type="checkbox"] {
    margin-right: 10px;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.server-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--ink-1);
}

.server-desc {
    font-size: 12px;
    color: var(--ink-3);
    margin: 6px 0 8px 28px;
}

.server-status {
    font-size: 11px;
    color: var(--ink-3);
    margin-left: 28px;
    padding: 4px 10px;
    background: rgba(27, 31, 42, 0.06);
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-mono);
}

.server-status.enabled {
    color: var(--accent-1);
    background: rgba(18, 106, 111, 0.12);
}

.server-status.error {
    color: var(--accent-2);
    background: rgba(224, 122, 95, 0.12);
}

.server-config {
    margin: 10px 0 0 28px;
}

.server-config input {
    width: 100%;
    max-width: 420px;
    padding: 9px 12px;
    background: #ffffff;
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--ink-1);
    font-size: 12px;
    font-family: var(--font-sans);
}

.server-config input:focus {
    outline: none;
    border-color: var(--accent-3);
    box-shadow: 0 0 0 3px rgba(43, 76, 126, 0.15);
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    background: rgba(255, 255, 255, 0.7);
}

.btn-primary,
.btn-secondary {
    padding: 9px 20px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    font-family: var(--font-sans);
    transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
}

.btn-primary {
    background: linear-gradient(135deg, #0f686c, #2b4c7e);
    color: #ffffff;
    box-shadow: var(--shadow-tight);
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-soft);
}

.btn-secondary {
    background: rgba(27, 31, 42, 0.08);
    color: var(--ink-2);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-tight);
}

@media (max-width: 720px) {
    .modal-content {
        margin: 8% auto;
        width: 94%;
    }

    .modal-footer {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>

<script>
function openMCPConfig() {
    document.getElementById('mcp-config-modal').style.display = 'block';
    loadMCPServerStates();
}

function closeMCPConfig() {
    document.getElementById('mcp-config-modal').style.display = 'none';
}

async function loadMCPServerStates() {
    try {
        const response = await fetch('/api/mcp/config');
        const config = await response.json();

        // Update checkboxes based on current config
        config.servers.forEach(server => {
            const checkbox = document.getElementById(`server-${server.name}`);
            if (checkbox) {
                checkbox.checked = server.enabled;
            }
        });
    } catch (error) {
        console.error('Failed to load MCP config:', error);
    }
}

async function toggleServer(serverName) {
    const checkbox = document.getElementById(`server-${serverName}`);
    const statusEl = document.getElementById(`status-${serverName}`);

    if (checkbox.checked) {
        statusEl.textContent = 'Enabling...';
        statusEl.className = 'server-status';
    } else {
        statusEl.textContent = 'Disabled';
        statusEl.className = 'server-status';
    }
}

async function saveMCPConfig() {
    const servers = [
        'filesystem', 'powershell', 'puppeteer', 'github',
        'brave_search', 'sequential_thinking', 'memory'
    ];

    const config = {};
    servers.forEach(name => {
        const checkbox = document.getElementById(`server-${name}`);
        if (checkbox) {
            config[name] = {
                enabled: checkbox.checked
            };

            // Get API keys/tokens if applicable
            const keyInput = document.getElementById(`config-${name}-key`);
            const tokenInput = document.getElementById(`config-${name}-token`);

            if (keyInput && keyInput.value) {
                config[name].api_key = keyInput.value;
            }
            if (tokenInput && tokenInput.value) {
                config[name].token = tokenInput.value;
            }
        }
    });

    try {
        const response = await fetch('/api/mcp/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });

        if (response.ok) {
            alert('MCP configuration saved! Servers will connect shortly.');
            closeMCPConfig();

            // Refresh server list
            setTimeout(() => {
                fetchMCPServers();
            }, 2000);
        } else {
            alert('Failed to save configuration');
        }
    } catch (error) {
        console.error('Failed to save MCP config:', error);
        alert('Error saving configuration');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('mcp-config-modal');
    if (event.target == modal) {
        closeMCPConfig();
    }
}
</script>
